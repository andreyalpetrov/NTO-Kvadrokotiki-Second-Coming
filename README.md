|||
| --- | --- |
| Трек | Летающая робототехника |
| Задание | Командное задание |
| Тип | Инструкция |
| Команда | КвадроКотики |

| Участник           | Роль                |
| ------------------ | ------------------- |
| • Андрей Петров    | инженер техник |
| • Даниил Белов     | инженер программист |
| • Иван Александров | инженер программист |
| • Дмитрий Ковалев  | 3D-моделлер         |

## 1. Установка виртуальной машины.

Для установки виртуальной машины необходимо скачать ПО для виртуализации (Virtual Box, WMVare Player или WMVare Workstation). 
В нашем примере мы будем использовать WMVare Workstation Pro. 
- Устанавливаем ПО для виртуализации;
- Скачиваем образ виртуальной машины с симулятором Клевера с репозитория по ссылке: 
 [Release v1.4 · CopterExpress/clover_vm](https://github.com/CopterExpress/clover_vm/releases/tag/v1.4) ;
 - Открываем ПО для виртуализации, нажимаем `CTRL+O` , или `File->Open` чтобы открыть существующую виртуальную машину. Выбираем скаченный файл `clover-devel_v1.4.ova`;
 - Нам предложат ввести название виртуальной машины. Называем `Clover`;
 - После установки образа и создания ВМ мы можем её настроить. Выбираем нашу ВМ в правой колонке `Library`. Затем нажимаем `Edit virtual machine settings`. В открывшемся окне настраиваем параметры:
	 - Memory. Необходимо выделить минимум половину от имеющейся оперативной памяти, но мы выбираем выделить около 12-13 Гб, т.к. в целом при 16Гб это не сильно повлияет на работоспособность ПК, но ускорит работу симуляции. 
	- Processors. Количество процессоров - 1 (Number of processors).
				Количество ядер - 3. (Number of cores per perocessor).
	- Network Adapter.  Выбрать тип соединения `Bridged: Connected directly to the physical network.` Поставить галочку  на `Connect at power on`. 
	
	Остальное можно оставить по умолчанию. Жмем кнопку `Ok`. Теперь отображаются актуальные параметры.
---
## 2. Настройка симулятора. 

После запуска виртуальной машины необходимо подготовить окружение. Для этого необходимо скачать наш репозиторий. Сделать это можно следующим образом:
```bash
cd ~/Desktop
git clone https://github.com/andreyalpetrov/NTO-Kvadrokotiki-Second-Coming.git
```


> [!IMPORTANT]
> Перед началом работы крайне важно убедится в том, что в терминале по умолчанию стоит кодировка UTF-8. В противном случае вся кириллица не будет отображаться.
> Для этого откройте терминал (ctrl+alt+T), зайдите сверху во вкладку `Terminal` - в ней найдите вкладку `Set Encoding`. Если у вас написано `Default(UTF-8)` - поздравляю, продолжайте работать дальше. В случае, если по дефолту стоит кодировка не UTF-8, необходимо ввести эти команды в терминал: 
> ```Bash
> localectl status
> ```
> Если тут написанно **НЕ** LANG=en_US.UTF-8 (а скорее всего оно написано не так), то выполняем эту функцию:
> ```Bash
> sudo localectl set-locale LANG=en_US.UTF-8
> ```
> **после этого необходимо перезагрузиться**


Для настройки симулятора был написан скрипт [launch.py](https://github.com/andreyalpetrov/NTO-Kvadrokotiki-Second-Coming/blob/main/launch.py "launch.py"), который выполняет следующие действия: 
- Скачивает Flask, который в дальнейшем понадобится при разработке веб-интерфейса
- Генерирует  aruco-карту 5 на 12 метров, изменяет дефолтную aruco-карту на только что сгенерированную в gazebo и применяет её к самому дрону
- копирует модели нефтепровода и мира gazebo
- Вносит необходимые изменения в файл `clover.launch` и `aruco.launch`

Далее вызываем терминал из рабочего стола, либо переходим с помощью команды и вызываем скрипт.
```bash
cd ~/Desktop/NTO-Kvadrokotiki-Second-Coming #Если вы все ещё не находитесь в данной дериктории - перейдите в неё
python3 launch.py
```
---
## 3. Случайная генерация мира.

Случайная генерация мира происходит с помощью скрипта [random_gen.py](https://github.com/andreyalpetrov/NTO-Kvadrokotiki-Second-Coming/blob/main/random_gen.py "random_gen.py"), который открывает файл `clover_aruco.world` и добавляет в него 5 случайно размещённых врезок.

> [!IMPORTANT]
> С каждым запуском скрипт генерирует расположение врезок случайно. 

Применение скрипта: 
- Закройте Gazebo. 
- Откройте терминал и вызовите следующие команды: 
```bash
cd ~/Desktop/NTO-Kvadrokotiki-Second-Coming #Если вы все ещё не находитесь в данной дериктории - перейдите в неё
python3 random_gen.py
```
- Запустите Gazebo 
---
## 4. Полетная миссия.

Для реализации полётной миссии были написаны 4 кода, они находятся в папке mission:

- [flight_api.py](https://github.com/andreyalpetrov/NTO-Kvadrokotiki-Second-Coming/blob/main/mission/flight_api.py "flight_api.py") - здесь написана функция navigate_wait и список переменных, которые понадобились в остальных кодах.
- [compute_vision.py](https://github.com/andreyalpetrov/NTO-Kvadrokotiki-Second-Coming/blob/main/mission/compute_vision.py "compute_vision.py") - этот код находит точку пересечения двух труб под углом в 90 градусов
- [campoint2globalcord.py](https://github.com/andreyalpetrov/NTO-Kvadrokotiki-Second-Coming/blob/main/mission/campoint2globalcord.py "campoint2globalcord.py") - этот код переводит координаты точки пересечения на картинке в глобальные координаты
- [main.py](https://github.com/andreyalpetrov/NTO-Kvadrokotiki-Second-Coming/blob/main/mission/main.py "main.py") - основной код полёта, в нём как раз используются все выше написанные скрипты

В связи с тем, что в `main.py` коды `compute_vision`, `campoint2globalcord` и `flight_api` подцепляются как библиотеки, мы можем запустить только mission.py, не запуская остальные скрипты. Нет смысла запускать `main.py` вручную, т.к. при запуске веб-сервера при нажатии на кнопку `start` всё само полетит.


Вкратце о работе всего этого:
 1) Дрон пролетает вдоль нефтепровода
 2) параллельно полёту выполняется мониторинг на предмет незаконных врезок
 3) при помощи функций в кодах `compute_vision` и `campoint2globalcord` выполняется точное определение глобальных координат врезок
 4) данные мониторинга транслируются в топики `/tubes` и `/insets_image` (insets_image был сделан для отладки)
 5) дрон возвращается в координату взлёта и производит автоматическую посадку

---
## 5. Работа с веб-сервисом.

Веб-сервис позволяет нам легко контролировать полёт дрона и отслеживать найденные врезки в удобном графическом интерфейсе.

Для работы веб-сервиса необходимо запустить [main.py](https://github.com/andreyalpetrov/NTO-Kvadrokotiki-Second-Coming/blob/main/server/main.py "main.py"), который работает в многопоточном режиме. В первом потоке он запускает ROS-ноду, во втором потоке - веб сервер.
При нажатии на кнопку `start` веб сервер отдельным процессом запускает код полёта [main.py](https://github.com/andreyalpetrov/NTO-Kvadrokotiki-Second-Coming/blob/main/mission/main.py "main.py"), при нажатии на `stop` -  веб сервер "убивает" процесс миссии по PID процесса.

Для запуска `main.py` в папке `server` откройте терминал и введите:
```Bash
cd ~/Desktop/NTO-Kvadrokotiki-Second-Coming
python3 ./server/main.py
```
